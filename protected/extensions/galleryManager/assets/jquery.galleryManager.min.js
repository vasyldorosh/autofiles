(function(a){function b(b,c){function k(a){return(a+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function l(b,c,e,f){var g='<div class="photo-editor"><div class="preview"><img src="'+k(c)+'" alt=""/></div>'+"<div>"+(d.hasName?'<label for="photo_name_'+b+'">'+d.nameLabel+":</label>"+'<input type="text" name="photo['+b+'][name]" class="input-xlarge" value="'+k(e)+'" id="photo_name_'+b+'"/>':"")+(d.hasDesc?'<label for="photo_description_'+b+'">'+d.descriptionLabel+":</label>"+'<textarea name="photo['+b+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+b+'">'+k(f)+"</textarea>":"")+"</div>"+"</div>";return a(g)}function m(b,c,e,f,g){var h='<div id="'+d.wId+"-"+b+'" class="photo">'+'<div class="image-preview"><img src="'+k(c)+'"/></div><div class="caption">';return d.hasName&&(h+="<h5>"+k(e)+"</h5>"),d.hasDesc&&(h+="<p>"+k(f)+"</p>"),h+='</div><input type="hidden" name="order['+b+']" value="'+g+'"/><div class="actions">'+(d.hasName||d.hasDesc?'<span data-photo-id="'+b+'" class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ':"")+'<span data-photo-id="'+b+'" class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>',a(h)}function n(b){b.preventDefault();var c=a(this).data("photo-id");return a.ajax({type:"POST",url:d.deleteUrl,data:"id="+c+e,success:function(b){b=="OK"?a("#"+d.wId+"-"+c).remove():alert(b)}}),!1}function o(b){b.preventDefault();var c=a(this).data("photo-id"),d=a(this).parents(".photo"),e=a("img",d[0]).attr("src"),f=a(".caption h5",d[0]).text(),g=a(".caption p",d[0]).text();return j.empty(),j.append(l(c,e,f,g)),i.modal("show"),!1}function p(){var b=a(".photo.selected",g).length;a(".select_all",f).prop("checked",a(".photo",g).length==b),b==0?a(".edit_selected, .remove_selected",f).addClass("disabled"):a(".edit_selected, .remove_selected",f).removeClass("disabled")}function q(){var b=a(this);b.is(":checked")?b.parent().addClass("selected"):b.parent().removeClass("selected"),p()}function r(b){a(".deletePhoto",b).click(n),a(".editPhoto",b).click(o),a(".photo-select",b).change(q)}this.defaults={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:!0,hasDesc:!0,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};var d=a.extend({},this.defaults,c),e=d.csrfToken?"&"+d.csrfTokenName+"="+d.csrfToken:"",f=a(b);d.wId=f.attr("id");var g=a(".sorter",f),h=a(".images",g),i=a(".editor-modal",f),j=a(".form",i);a(".photo",f).each(function(){r(this)}),a(".images",g).sortable().disableSelection().bind("sortstop",function(){a.post(d.arrangeUrl,a("input",g).serialize()+"&ajax=true"+e,function(){},"json")}),typeof window.FormData=="function"?a(".afile",f).attr("multiple","true").on("change",function(a){a.preventDefault();var b=this.files.length,c=0;j.empty();for(var e=0;e<b;e++){var f=new FormData;f.append(this.name,this.files[e]),d.csrfToken&&f.append(d.csrfTokenName,d.csrfToken);var g=new XMLHttpRequest;g.open("POST",d.uploadUrl,!0),g.onload=function(){c++;if(this.status==200){var a=JSON.parse(this.response),e=m(a.id,a.preview,a.name,a.description,a.rank);r(e),h.append(e),(d.hasName||d.hasDesc)&&j.append(l(a.id,a.preview,a.name,a.description))}c===b&&(d.hasName||d.hasDesc)&&i.modal("show")},g.send(f)}}):a(".afile",f).on("change",function(b){b.preventDefault(),j.empty(),a.ajax(d.uploadUrl,{data:d.csrfToken?d.csrfTokenName+"="+d.csrfToken:"",files:a(this),iframe:!0,dataType:"json"}).done(function(a){var b=m(a.id,a.preview,a.name,a.description,a.rank);r(b),h.append(b),(d.hasName||d.hasDesc)&&j.append(l(a.id,a.preview,a.name,a.description)),(d.hasName||d.hasDesc)&&i.modal("show")})}),a(".save-changes",i).click(function(b){b.preventDefault(),a.post(d.updateUrl,a("input, textarea",j).serialize()+"&ajax=true"+e,function(b){var c=b.length;for(var e=0;e<c;e++){var h=b[e],j=a("#"+d.wId+"-"+h.id);a("img",j).attr("src",h.src),d.hasName&&a(".caption h5",j).text(h.name),d.hasDesc&&a(".caption p",j).text(h.description)}i.modal("hide"),a(".photo.selected",g).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected"),a(".select_all",f).prop("checked",!1),p()},"json")}),a(".edit_selected",f).click(function(b){b.preventDefault();var c=0,e=j.empty();return a(".photo.selected",g).each(function(){c++;var b=a(this),f=b.attr("id").substr((d.wId+"-").length),g=a("img",b[0]).attr("src"),h=a(".caption h5",b[0]).text(),i=a(".caption p",b[0]).text();e.append(l(f,g,h,i))}),c>0&&i.modal("show"),!1}),a(".remove_selected",f).click(function(b){b.preventDefault(),a(".photo.selected",g).each(function(){var b=a(this).attr("id").substr((d.wId+"-").length);a.ajax({type:"POST",url:d.deleteUrl,data:"id="+b+e,success:function(c){c=="OK"?a("#"+d.wId+"-"+b).remove():alert(c)}})})}),a(".select_all",f).change(function(){a(this).prop("checked")?a(".photo",g).each(function(){a(".photo-select",this).prop("checked",!0)}).addClass("selected"):a(".photo.selected",g).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected"),p()});for(var s in d.photos){var t=d.photos[s],u=m(t.id,t.preview,t.name,t.description,t.rank).data("data",t);r(u),h.append(u)}}a.fn.galleryManager=function(a){this.length&&this.each(function(){b(this,a)})}})(jQuery);